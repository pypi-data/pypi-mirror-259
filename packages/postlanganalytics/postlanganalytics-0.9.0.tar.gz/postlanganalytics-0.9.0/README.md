# Postlang Python

[![PyPI](https://img.shields.io/pypi/v/postlang)](https://pypi.org/project/postlang/)

This is the python client package to send events to an instance of the postlang server. This client package is built on top of PostHog generic events and you can also send any time of event to the postlang server. The postlang client LLM specific functions are also compatible with PostHog servers.

## Instalation

```
pip install postlang
```

In the app set the api key and host before making calls.

```
import postlang

# the project API key is found in the project settings page 
postlang.project_api_key = '<project_api_key>'
# the instance address of your postlang server eg. https://postlang.mydomain.com
postlang.host = '<instance_address>'
```

## Sending events

To send LLM task events use the task function. The required inputs:

- **distinct_id** an identifier of the user doing the event (the username in the platform, the email or some other unique identifier)
- **input** the input to the LLM, either the text of the input prompt or a list of dictionaries with chat turns in chatml format
- **output** the text generated by the LLM

Optional inputs:

- **properties** a dictionary with additinal metadata properties to store with the event (eg. model name)
- **timestamp** if a datetime object is sent, the event will be recorded with this timestamp
- **session_id** an unique identifier to group a sequence of tasks, like a dialog with a chatbot
- **event** the name of the event (by default "llm-task") 

Some examples:

```python
postlang.task("john@example.com", "hello!", "hi there!", properties={"model": "gpt-3.5-turbo"})
```

```python
inputs = [
    {"role": "user", "content": "hello!"}, 
    {"role": "assistant", "content": "hi there!"},
    {"role": "user", "content": "What is the largest ocean?"}, 
]
postlang.task("john@example.com", inputs, "The largest ocean on Earth is the Pacific Ocean", 
               properties={"model": "gpt-3.5-turbo"})
```

The generic events are sent with `capture`. Required inputs:

- **distinct_id** an identifier of the user doing the event (the username in the platform, the email or some other unique identifier)
- **event** the name of the event

Optional inputs:

- **properties** a dictionary with additinal metadata properties to store with the event
- **timestamp** if a datetime object is sent, the event will be recorded with this timestamp


Example:

```python
postlang.capture("john@example.com", "conversation_deleted", properties={"$session_id": "dkGgdYT"})
```

With `identify` it is possible to set metadata properties in the user.

```python
postlang.identify('john@example.com', properties={'plan': 'premium'})
```

The `examples` folder has several examples of using postlang with openAI, langchain and uploading data directly to the server.

## LangChain handler

When using a LangChain agent it may be helpful to record the inputs and 
outputs from the LLM call instead of the inputs and outputs from the agent.
To record the LLM call we can use the `PostlangCallbackHandler` callback in 
the chain execution (see the full example in `examples/langchain_handler.py`).

```python
from postlang.handlers.langchain import PostlangCallbackHandler

...

    response = chain.invoke(
        {"input": message}, 
        config={"callbacks": [
            PostlangCallbackHandler(distinct_id=user_id, session_id=session_id)
            ]}
    )
```


## Development

### Testing Locally

1. Run `python3 -m venv env` (creates virtual environment called "env")
2. Run `source env/bin/activate` (activates the virtual environment)
3. Run `python3 -m pip install -e ".[test]"` (installs the package in develop mode, along with test dependencies)
4. Run `make test`

### Running Locally

Assuming you have a [local version of postlang](https://github.com/postlang/postlang) running, you can run `python3 examples/upload_dataset.py` to upload some LLM interactions to the server. You can also run the chatbots in the examples folder to see the library in action.

## Thank you

This package is based on the open-source work of `posthog-python` and `segment-analytics-python`. Our heartfelt thank you to the authors.