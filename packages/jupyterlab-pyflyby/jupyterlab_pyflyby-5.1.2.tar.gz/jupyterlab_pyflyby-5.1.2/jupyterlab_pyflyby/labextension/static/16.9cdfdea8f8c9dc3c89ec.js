"use strict";(self.webpackChunk_deshaw_jupyterlab_pyflyby=self.webpackChunk_deshaw_jupyterlab_pyflyby||[]).push([[16],{16:(e,t,o)=>{o.r(t),o.d(t,{default:()=>R});var s=o(620),n=o(760),i=o(52),r=o(672),l=o(688),a=o(768),c=o(508),d=o(292),h=o(632),m=o(512),u=o.n(m);const g="pyflyby-cell",y="# THIS CELL WAS AUTO-GENERATED BY PYFLYBY\n",p="# END AUTO-GENERATED BLOCK\n",_="pyflyby.missing_imports",f="pyflyby.format_imports",b="pyflyby.init_comms",C="pyflyby.tidy_imports",w=e=>"string"==typeof e?e.split("\n"):e,k=e=>!(e.startsWith("#")||e.startsWith('"""')||""===e.trim()||e.match(/^\s.*$/))||e.startsWith("%"),x=e=>""===e.trim()||!e.match(/^\s.*$/);var S=o(188),L=o(852);async function T(e="",t={}){const o=L.ServerConnection.makeSettings(),s=S.URLExt.join(o.baseUrl,"pyflyby",e);let n;try{n=await L.ServerConnection.makeRequest(s,t,o)}catch(e){throw new L.ServerConnection.NetworkError(e)}let i=await n.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",n)}if(!n.ok)throw new L.ServerConnection.ResponseError(n,i.message||i);return i}const I=(0,h.debug)("PYFLYBY:");class Y{constructor(e,t){this._recentKernelState="",this._lockTimeout=e,this._activeTimeout=void 0,this.requestedLockCount=0,this.clearedLockCount=0,this._releaseLock={},this.promise={0:Promise.resolve()},this._timeoutSignal=new d.Signal(this),this._sessionContext=t,this._sessionContext.statusChanged.connect(this.kernelStateRecorder,this),this._timeoutSignal.connect(this.timeoutExpireHandler,this)}kernelStateRecorder(e,t){this._recentKernelState=t}_clearTimeout(){window.clearTimeout(this._activeTimeout),this._activeTimeout=void 0}timeoutExpireHandler(e,t){this._clearTimeout(),"busy"===this._recentKernelState?(console.debug("Extending Timeout For: ",t),this.createTimeout(t)):this.release(t)}async acquire(){const e=this.promise[this.requestedLockCount];this.requestedLockCount++;const t=this.requestedLockCount;return this.promise[t]=new Promise((e=>{this._releaseLock[t]=e})),await e,new Promise(((e,o)=>e(t)))}release(e){var t,o;this.clearedLockCount=e,null===(o=(t=this._releaseLock)[e])||void 0===o||o.call(t),delete this._releaseLock[e],this._clearTimeout(),this.clearedLockCount<this.requestedLockCount&&this.createTimeout(e+1)}createTimeout(e){this._activeTimeout=setTimeout((()=>{this._timeoutSignal.emit(e)}),this._lockTimeout)}}let M=!1;class E extends n.Widget{constructor(e,t,o){super(),this._comms={},o.load("@deshaw/jupyterlab-pyflyby:plugin").then((e=>{this._settings=e,(e.get("enabled").user||e.get("enabled").composite)&&(this._sessionContext.kernelChanged.connect(this._handleKernelChange,this),this._sessionContext.statusChanged.connect(this._handleKernelStatusChange,this));const t=1e3*(e.get("lockTimeout").user||e.get("lockTimeout").composite);this._lock=new Y(t,this._sessionContext)}),(e=>{I("PYFLYBY extension has been disabled")})),this._context=e,this._sessionContext=e.sessionContext}async _launchDialog(e){const t=new i.Dialog({title:"PYFLYBY",body:"PYFLYBY will be adding imports to the first code cell in the notebook.\n            To disable the PYFLYBY extension or to disable this notification in future, go\n            to Settings -> Advanced Settings Editor and choose PYFLYBY preferences tab",buttons:[i.Dialog.okButton()]});try{return await t.launch(),e}catch(e){console.error(e)}}_findAndSetImportCoordinates(){const{model:e}=this._context;let t=s.ArrayExt.findFirstIndex(Array.from(e.cells),((e,t)=>{const o=e.getMetadata("tags");return!(!o||-1===o.indexOf(g))}));-1===t&&(t=(e=>{const t=(0,s.toArray)(e);for(let e=0;e<t.length;e++){const o=t[e];if("code"===o.type){const t=w(o.toJSON().source);if(t.length>0&&!t[0].startsWith("%")&&!t[0].startsWith('"""'))for(let o=0;o<t.length;o++)if(k(t[o]))return e}}return-1})(Array.from(e.cells)));let o=e.cells.get(t).sharedModel,n=(e=>{const t=w(e.toJSON().source);for(let e=t.length-1;e>=0;e--)if(t[e]===p.substr(0,p.length-1)){let o=0;for(let s=0;s<e-1;s++)o+=t[s].length+1;return o}for(let e=t.length-1;e>=0;e--)if(o=t[e],k(o)&&(o.includes("__future__")||-1!==o.split(" ").indexOf("import")||o.includes("import_all_names"))&&(e===t.length-1||x(t[e+1]))){let o=0;for(let s=0;s<=e;s++)o+=t[s].length+1;return o}var o;return-1})(e.cells.get(t));return-1===n&&(t=0,o=this._context.model.sharedModel.insertCell(0,{source:`${y}\n\n${p}`,cell_type:"code",metadata:{}}),n=y.length+1),o.setMetadata("tags",[g]),{cellIndex:t,position:n}}_insertImport(e){let t;return M||!this._settings||this._settings.get("disableNotification").user?t=Promise.resolve(e):(t=this._launchDialog(e),M=!0),this._findAndSetImportCoordinates(),t}_sendFormatCodeMsg(e,t){const o=s.ArrayExt.findFirstIndex(Array.from(this._context.model.cells),((e,t)=>{const o=e.getMetadata("tags");return!(!o||-1===o.indexOf(g))}));if(-1!==o){const s=this._context.model.cells.get(o).toJSON().source,n=this._comms[f];n&&!n.isDisposed&&n.send({msg_id:t,input_code:s,imports:e,type:f})}}async sendTidyImportRequest(){const e=this._getCellArray(),t=this._comms[C];t&&!t.isDisposed&&t.send({type:C,cellArray:e,checksum:this._getHashOfCodeInNotebook()})}_getCellArray(){const e=this._context.model.cells,t=[];for(let o=0;o<e.length;++o)t.push({text:e.get(o).sharedModel.getSource(),type:e.get(o).type});return t}restoreNotebookAfterTidyImports(e,t){const o=this._context.model.cells;for(let t=0;t<e.length;++t)o.get(t).sharedModel.setSource(e[t].text.trim());const s=t.trim(),{cellIndex:n}=this._findAndSetImportCoordinates(),i=(e=>{const t=w(e.toJSON().source);let o=-1,s=-1;for(let e=0;e<t.length;++e)t[e]===y.trim()&&(o=e),t[e]===p.trim()&&(s=e);return t.splice(o,s-o+1).splice(o+1,s-o-1).join(),t.join("")})(o.get(n));if(""!==i){o.get(n).sharedModel.setSource(i);const e=o.get(n).getMetadata("tags");e.splice(e.indexOf(g)),o.get(n).setMetadata("tags",e),this._context.model.sharedModel.insertCell(0,{source:[y,s,p].join("\n"),cell_type:"code",metadata:{trusted:!0,tags:[g]}})}else o.get(n).sharedModel.setSource([y,s,p].join("\n"));this._cleanupNotebook()}_cleanupNotebook(){const e=this._context.model.cells,t=[];for(let o=0;o<e.length;++o){const s=e.get(o).sharedModel.getSource().split("\n");let n=!0;for(let e=0;e<s.length;++e){const t=s[e].trim();""!==t&&t!==y.trim()&&t!==p.trim()&&(n=!1)}n&&t.push(o)}this._context.model.sharedModel.transact((()=>{for(let e=t.length-1;e>=0;--e)this._context.model.sharedModel.deleteCell(t[e])}))}_fastStringHash(e){let t=0;for(let o=0,s=e.length;o<s;o++)t=(t<<5)-t+e.charCodeAt(o),t|=0;return t}_getHashOfCodeInNotebook(){const e=this._getCellArray();let t="";for(let o=0;o<e.length;++o)t+=e[o].text;return this._fastStringHash(t)}_getCommMsgHandler(){return async e=>{const t=e.content.data;switch(t.type){case _:{const e=t.missing_imports;this._insertImport(e).then((async e=>{if(void 0!==this._lock){const t=await this._lock.acquire();this._sendFormatCodeMsg(e,t)}}));break}case f:{this._formatImports(t);const{msg_id:e}=t;void 0!==this._lock&&this._lock.release(e);break}case b:this._initializeComms().catch(console.error);break;case C:{const{cells:e,imports:o,checksum:s}=t;s===this._getHashOfCodeInNotebook()?this.restoreNotebookAfterTidyImports(e,o):await(0,i.showDialog)({title:"TidyImports Interrupted",body:"TidyImports could not be run because code in the notebook has been changed",buttons:[i.Dialog.okButton({label:"Ok"})],defaultButton:0});break}}}}async _initializeComms(){if(!this._sessionContext.session)return;const{kernel:e}=this._sessionContext.session;if(!e)return;const t=_,o=e.createComm(t);o.onMsg=this._getCommMsgHandler();try{o.open()}catch(e){console.error(`Unable to open PYFLYBY comm - ${e}`)}const s=e.createComm(f);s.onMsg=this._getCommMsgHandler(),s.onClose=e=>{const t=e.content.comm_id;delete this._comms[t]},this._comms[f]=s;try{s.open()}catch(e){console.error(`Unable to open PYFLYBY comm - ${e}`)}const n=e.createComm(C);n.onMsg=this._getCommMsgHandler(),this._comms[C]=n;try{n.open()}catch(e){console.error(`Unable to open PYFLYBY comm - ${e}`)}return e.registerCommTarget(b,((e,t)=>{e.onMsg=this._getCommMsgHandler()})),Promise.resolve()}_formatImports(e){const{formatted_code:t}=e,o=s.ArrayExt.findFirstIndex(Array.from(this._context.model.cells),((e,t)=>{const o=e.getMetadata("tags");return!(!o||-1===o.indexOf(g))}));if(-1!==o){const e=this._context.model.cells.get(o).sharedModel;e.updateSource(0,e.source.length,t)}}async _handleKernelChange(e,t){return await this._initializeComms()}_handleKernelStatusChange(e,t){return"restarting"===t?this._initializeComms():null}}class v{constructor(e){this._settingRegistry=e,this._loadSettings().catch(console.error)}async _loadSettings(){try{await this._settingRegistry.load("@deshaw/jupyterlab-pyflyby:plugin"),I("Successfully loaded PYFLYBY extension settings")}catch(e){console.error("Settings could not be loaded")}}createNew(e,t){return P=new E(t,e,this._settingRegistry),P}}async function N(){try{await T("install-pyflyby",{method:"POST"})}catch(e){console.error(e)}}const A=u().createElement("div",null,u().createElement("p",null,"To use @deshaw/jupyterlab-pyflyby,"," ",u().createElement("a",{href:"https://github.com/deshaw/pyflyby/blob/master/README.rst",style:{color:"#0000EE"},target:"_blank",rel:"noopener noreferrer"},"pyflyby")," ","ipython extension needs to be installed."),u().createElement("br",null),u().createElement("p",null,'Clicking on "Install" will run following command'),u().createElement("div",{style:{font:"monospace",color:"#ffffff",backgroundColor:"#000000",marginTop:"5px"}},"$ py pyflyby.install_in_ipython_config_file"),u().createElement("br",null));class B{createNew(e,t){const o=new i.ToolbarButton({className:"tidy-import-button",tooltip:"Run tidy-imports on this notebook",icon:D,onClick:()=>P.sendTidyImportRequest()});return e.toolbar.insertItem(10,"tidy-imports",o),new c.DisposableDelegate((()=>{o.dispose()}))}}const D=new a.LabIcon({name:"TidyImports",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\x3c!-- Font Awesome Pro 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) --\x3e<path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38C411.53 3.12 403.34 0 395.15 0c-8.19 0-16.38 3.12-22.63 9.38L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c6.25 6.25 14.44 9.37 22.62 9.37 8.19 0 16.38-3.12 22.63-9.37l363.14-363.15c12.5-12.48 12.5-32.75 0-45.24zM359.45 203.46l-50.91-50.91 86.6-86.6 50.91 50.91-86.6 86.6z"/></svg>'});let P=null;const O="djs:run-tidy-imports",R={id:"@deshaw/jupyterlab-pyflyby:plugin",autoStart:!0,requires:[r.ISettingRegistry,l.INotebookTracker,i.ICommandPalette],activate:async function(e,t,o,s){console.log("JupyterLab extension @deshaw/jupyterlab-pyflyby is activated!"),e.commands.addCommand(O,{execute:()=>P.sendTidyImportRequest(),icon:D,label:"Run tidy-imports on Notebook"}),s.addItem({command:O,category:"Notebook"});const n=await t.load("@deshaw/jupyterlab-pyflyby:plugin"),r=n.get("enabled").user||n.get("enabled").composite,l=n.get("installDialogDisplayed").user;r&&"loaded"!==await async function(){return(await T("pyflyby-status")).status}()&&(l||(await(0,i.showDialog)({title:"Installation required",body:A,buttons:[i.Dialog.okButton({label:"Install"}),i.Dialog.cancelButton({label:"Cancel",displayType:"default"})],defaultButton:0})).button.accept?await N():await async function(e){try{await T("disable-pyflyby",{method:"POST",mode:"cors",cache:"no-cache",credentials:"include",headers:{"Content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams("installDialogDisplayed=true")})}catch(e){console.error(e)}await e.reload("@deshaw/jupyterlab-pyflyby:plugin")}(t)),e.docRegistry.addWidgetExtension("Notebook",new v(t)),e.docRegistry.addWidgetExtension("Notebook",new B)}}}}]);